{%- assign filterFound = false -%}

{%- for parameter in operation.QueryParameters -%}
  {%- if parameter.VariableName contains "filter" -%}
    {%- assign filterFound = true -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}

{%- if operation.IsGet == true -%}
let options_: RequestInit = {
  {%- if operation.HasBody -%}
  body: content_,
  {%- endif -%}
  method: "{{ operation.HttpMethodUpper | upcase }}",
  {%- if UseAbortSignal -%}
  signal,
  {%- endif -%}
  headers: await getHeaders("{{ operation.HttpMethodUpper | upcase }}", String(baseUrl)),
  {%- if filterFound  -%}
  {%- else -%}
  {%- if operation.IsCacheEnabled == true -%}
  next: { revalidate: 60 }
  {%- else -%}
  next: { revalidate: 0 }
  {%- endif -%}
  {%- endif -%}
};
{%- if filterFound -%}
options_ = addCacheOption(filter ?? [], options_);
{%- endif -%}
{%- endif -%}

let url_ = baseUrl + "{{ operation.Path }}{% if operation.HasQueryParameters %}{% endif %}";
{%     if operation.HasQueryParameters -%}
{%     if operation.IsGetOrDeleteOrHead == true or  operation.IsPost == true-%}
       url_ += BuildEndpointQueryString({% raw %}{{% endraw %}{% for parameter in operation.QueryParameters %} {{parameter.VariableName }}{% if GenerateOptionalParameters and parameter.IsOptional %} = null{% endif %}{% if parameter.IsLast == false %}, {% endif %}{% endfor %}{% raw %}}{% endraw %});
{%         endif -%}
    {%     endif -%}
{% for parameter in operation.PathParameters -%}
{%    if parameter.IsRequired -%}
if ({{ parameter.VariableName }} === undefined || {{ parameter.VariableName }} === null)
    throw new Error("The parameter '{{ parameter.VariableName }}' must be defined.");
{%    else -%}
if ({{ parameter.VariableName }} !== null && {{ parameter.VariableName }} !== undefined)
{%    endif -%}
{%    if parameter.IsDateOrDateTimeArray -%}
url_ = url_.replace("{{ "{" }}{{ parameter.Name }}}", encodeURIComponent({{ parameter.VariableName }}.map(s_ => s_ ? s_.{{ parameter.GetDateTimeToString }} : "null").join()));
{%    elsif parameter.IsDateOrDateTime -%}
url_ = url_.replace("{{ "{" }}{{ parameter.Name }}}", encodeURIComponent({{ parameter.VariableName }} ? "" + {{ parameter.VariableName }}.{{ parameter.GetDateTimeToString }} : "null"));
{%    elsif parameter.IsArray -%}
url_ = url_.replace("{{ "{" }}{{ parameter.Name }}}", encodeURIComponent({{ parameter.VariableName }}.join()));
{%    else -%}
url_ = url_.replace("{{ "{" }}{{ parameter.Name }}}", encodeURIComponent("" + {{ parameter.VariableName }}));
{%    endif -%}
{%    if parameter.IsOptional -%}
else
    url_ = url_.replace("/{{ "{" }}{{ parameter.Name }}}", "");
{%    endif -%}
{% endfor -%}
{% for parameter in operation.QueryParameters -%}
{%    if parameter.IsRequired -%}
{%        if parameter.IsNullable -%}
if ({{ parameter.VariableName }} === undefined)
    throw new Error("The parameter '{{ parameter.VariableName }}' must be defined.");
else if({{ parameter.VariableName }} !== null)
{%        else -%}
if ({{ parameter.VariableName }} === undefined || {{ parameter.VariableName }} === null)
    throw new Error("The parameter '{{ parameter.VariableName }}' must be defined and cannot be null.");
else
{%        endif -%}
{%    else -%}
{%        if parameter.IsNullable -%}
if ({{ parameter.VariableName }} !== undefined && {{ parameter.VariableName }} !== null)
{%        else -%}
if ({{ parameter.VariableName }} === null)
    throw new Error("The parameter '{{ parameter.VariableName }}' cannot be null.");
{%    endif -%}
{%    endif -%}
{% endfor -%}
url_ = url_.replace(/[?&]$/, "");